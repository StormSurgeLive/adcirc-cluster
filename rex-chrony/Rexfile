use Rex -feature => ['1.16'];
set remote_perl => "/usr/bin/perl";

use Rex::Commands::Fs;
use Rex::Commands::Run;
use Rex::Commands::Pkg;
use Rex::Commands::Service;
use Rex::Commands::File;
use Rex::Commands::User;
use Rex::Group;

# Define the host groups
group head     => 'compute01';
group workers  => 'compute02', 'compute03';
group allnodes => 'compute01', 'compute02', 'compute03';

# Set the SSH user (replace with your actual username)
user "user";

# Enable sudo for all tasks
sudo TRUE;

# Main task to install and configure Chrony
task "setup_chrony", group => "allnodes", sub {
  my $hostname = connection->server;
  my $is_head  = ($hostname eq 'compute01');

  # Update package index
  run "apt-get update -qq";

  # Install Chrony
  pkg "chrony", ensure => "present";

  # Push correct config file
  file "/etc/chrony/chrony.conf",
    source => $is_head ? "files/chrony-head.conf" : "files/chrony-worker.conf",
    owner  => "root",
    group  => "root",
    mode   => 0644;

  # Enable and start Chrony service
  service "chrony" => {
    ensure => "started",
    enable => 1,
  };
};

